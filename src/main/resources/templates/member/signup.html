<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org">
<div th:replace="~{top::menu}"></div>
<title>TEST MEMBER</title>
<body>
<!-- id check -->
<script>
    var isidAvailable = false;

    $(document).ready(function () {
        $("#id_check").click(function () {
            var id = $("#id").val();
            var idRegex = /^[a-zA-Z0-9]{4,12}$/;

            if (!idRegex.test(id)) {
                alert('아이디는 4자 ~ 12자 이하의 영문자 또는 숫자만 가능합니다.');
                $("#id").focus();
                return;
            }

            $.ajax({
                type: "post",
                url: "/check/id",
                data: {"id": id},
                success: function (data) {
                    if (data === "ok") {
                        alert("사용 가능한 아이디입니다.");
                        isidAvailable = true;
                    } else {
                        alert("이미 사용중인 아이디입니다.");
                        isidAvailable = false;
                        $("#id").focus();
                    }
                },
                error: function () {
                    alert("서버 통신 중 오류가 발생했습니다.");
                }
            });
        });
    });
</script>

<!-- pw check -->
<script>
    var isPwMatch = false;

    $(document).ready(function () {
        $("#pw_check_btn").click(function () {
            var pw = $("#pw").val();
            var pwCheck = $("#pw_check").val();

            if(pw === "" || pwCheck === "") {
                alert("비밀번호를 모두 입력해주세요.");
                return;
            }

            $.ajax({
                type: "post",
                url: "/check/pw",
                data: { "pw": pw, "pwCheck": pwCheck },
                success: function (data) {
                    if(data === "match") {
                        $("#pw_check_msg").text("비밀번호가 일치합니다.").css("color", "green");
                        isPwMatch = true;
                    } else {
                        $("#pw_check_msg").text("비밀번호가 일치하지 않습니다.").css("color", "red");
                        isPwMatch = false;
                        $("#pw_check").focus();
                    }
                },
                error: function () {
                    alert("서버 통신 중 오류가 발생했습니다.");
                }
            });
        });

        $("form").submit(function () {
            if(!isPwMatch) {
                alert("비밀번호가 일치하지 않습니다.");
                return false;
            }
        });
    });
</script>

<!-- NICKNAME check -->
<script>
    var isNickMatch = false;

    $(document).ready(function () {
        $("#nick_check_btn").click( function () {
            var nickname = $("#nickname").val();

            if(nickname === "") {
                alert("닉네임을 입력해주세요.");
                return;
            }

            $.ajax({
                type:"post",
                url:"/check/nickname",
                data:{"nickname":nickname},
                success: function(data) {
                    if(data === "match"){
                        $("#nick_check_msg").text("사용 가능한 닉네임입니다.").css("color", "green");
                        isNickMatch = true;
                    } else {
                        $("#nick_check_msg").text("이미 사용중인 닉네임입니다.").css("color", "red");
                        isNickMatch = false;
                        $("#nickname").focus().select();
                    }
                },
                error: function () {
                    alert("서버 통신 중 오류가 발생했습니다.");
                }
            });
        });

        $("form").submit(function() {
            if(!isNickMatch){
                alert("닉네임 중복 확인을 완료해주세요.");
                $("#nickname").focus().select();
                return false;
            }
        });
    });
</script>

<!-- PHONE check -->
<script>
    var isPhoneValid = false;

    function formatPhone(phone) {
        phone = phone.replace(/\D/g, "");
        if(phone.length < 4) return phone;
        if(phone.length < 7) return phone.replace(/(\d{3})(\d{1,3})/, "$1-$2");
        if(phone.length < 11) return phone.replace(/(\d{3})(\d{3,4})(\d{1,4})/, "$1-$2-$3");
        return phone.replace(/(\d{3})(\d{4})(\d{4})/,"$1-$2-$3");
    }

    function validatePhone(phone) {
        phone = phone.replaceAll(/\D/g,"");
        var regex = /^01[0-9]{8,9}$/;
        return regex.test(phone);
    }

    $(document).ready(function () {
        $("#phone").on("keyup", function() {
            var formatted = formatPhone($(this).val());
            $(this).val(formatted);
        });

        $("#phone_check_btn").click(function() {
            var phone = $("#phone").val()

            if(phone === "") {
                alert("전화번호를 입력해주세요.");
                return;
            }

            if(!validatePhone(phone)) {
                $("#phone_check_msg").text("전화번호 형식이 올바르지 않습니다.").css("color", "red");
                isPhoneValid = false;
                return;
            }

            $.ajax({
                type : "post",
                url : "/check/phone",
                data : {"phone": phone},
                success : function (data) {
                    if(data === "match") {
                        $("#phone_check_msg").text("사용 가능한 전화번호입니다.").css("color","green");
                        isPhoneValid = true;
                    } else {
                        $("#phone_check_msg").text("이미 사용중인 전화번호입니다.").css("color","red");
                        isPhoneValid = false;
                        $("#phone").focus().select();
                    }
                },
                error: function () {
                    alert("서버 통신 중 오류가 발생했습니다.");
                }
            });
        });

        $("form").submit(function () {
            if(!isPhoneValid) {
                alert("전화번호 확인 버튼을 눌러 중복 확인을 완료해주세요.");
                $("#phone").focus().select();
                return false;
            }
        });
    });
</script>

<div>
    <h2>회원가입</h2>
    <form th:action="@{/signup_save}" th:object="${memberDTO}" method="post">

        <!-- ID ajax 유효성 검사 -->
        <div>
            <label>ID: </label>
            <input type="text" id="id" name="id"/>
            <button type="button" name="id_check" id="id_check">ID CHECK</button>
        </div>

        <!-- Validation 유효성 검사 -->
        <!--
        <div>
            <label>ID: </label>
            <input type="text" th:field="*{id}" />
            <p th:if="${#fields.hasErrors('id')}" th:errors="*{id}"></p>
        </div>
        -->

        <!-- 비밀번호 -->
        <div>
            <label>PW: </label>
            <input type="password" id="pw" name="pw"/>
        </div>

        <!-- 비밀번호 확인 -->
        <div>
            <label>PW CHECK: </label>
            <input type="password" id="pw_check" name="pwcheck"/>
            <button type="button" id="pw_check_btn">비밀번호 확인</button>
            <span id="pw_check_msg" style="color:red;"></span>
        </div>

        <!-- 닉네임 중복검사 -->
        <div>
            <label>NICKNAME: </label>
            <input type="text" id="nickname" name="nickname"/>
            <button type="button" id="nick_check_btn">닉네임 확인</button>
            <span id="nick_check_msg" style="color:red;"></span>
        </div>

        <!-- 전화번호 유효성 검사 -->
        <div>
            <label>CELLPHONE: </label>
            <input type="text" id="phone" name="phone" maxlength="13"/>
            <button type="button" id="phone_check_btn">전화번호 확인</button>
            <span id="phone_check_msg"></span>
        </div>


        <div>
            <label>ADRESS: </label>
            <input type="text" id="madress" name="madress"/>
        </div>

        <input type="hidden" id="role" name="role" value="USER" />

        <button type="submit">SUBMIT</button>
    </form>
</div>
</body>
</html>